# Publishes the semgrep-metaflow-extensions package to AWS CodeArtifact
# Triggers on:
# - Manual workflow dispatch

name: publish-to-codeartifact

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (build only, do not publish)"
        required: false
        type: boolean
        default: false

env:
  # CodeArtifact configuration
  CODEARTIFACT_DOMAIN: r2c
  CODEARTIFACT_DOMAIN_OWNER: "338683922796"
  CODEARTIFACT_REPOSITORY: pypi
  AWS_REGION: us-west-2

jobs:
  build-and-publish:
    name: Build and Publish to CodeArtifact
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Required for OIDC authentication

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade setuptools wheel build twine

      - name: Build package
        run: |
          python -m build
          echo "Built packages:"
          ls -la dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::338683922796:role/ai-betaflow-flows-deploy-role
          role-duration-seconds: 900
          role-session-name: "metaflow-extensions-publish-gha"
          aws-region: us-west-2

      - name: Get CodeArtifact auth token
        id: codeartifact-login
        run: |
          CODE_ARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.CODEARTIFACT_DOMAIN_OWNER }} \
            --query authorizationToken \
            --output text)
          echo "token=$CODE_ARTIFACT_AUTH_TOKEN" >> $GITHUB_OUTPUT

      - name: Get CodeArtifact repository URL
        id: codeartifact-url
        run: |
          REPOSITORY_URL=$(aws codeartifact get-repository-endpoint \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.CODEARTIFACT_DOMAIN_OWNER }} \
            --repository ${{ env.CODEARTIFACT_REPOSITORY }} \
            --format pypi \
            --query repositoryEndpoint \
            --output text)
          echo "url=$REPOSITORY_URL" >> $GITHUB_OUTPUT
          echo "Repository URL: $REPOSITORY_URL"

      - name: Publish to CodeArtifact
        if: ${{ !inputs.dry_run }}
        env:
          TWINE_USERNAME: aws
          TWINE_PASSWORD: ${{ steps.codeartifact-login.outputs.token }}
        run: |
          echo "Publishing to CodeArtifact..."
          twine upload --repository-url "${{ steps.codeartifact-url.outputs.url }}" dist/*

      - name: Dry run - skip publish
        if: ${{ inputs.dry_run }}
        run: |
          echo "Dry run mode - skipping publish"
          echo "Would publish the following packages:"
          ls -la dist/
          echo ""
          echo "To repository: ${{ steps.codeartifact-url.outputs.url }}"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/
          retention-days: 30

      - name: Summary
        run: |
          echo "## Package Published to CodeArtifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Domain:** ${{ env.CODEARTIFACT_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ env.CODEARTIFACT_REPOSITORY }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Built Packages" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la dist/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "**Mode:** Dry Run (not published)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Published" >> $GITHUB_STEP_SUMMARY
          fi
